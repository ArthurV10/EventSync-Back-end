generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "windows"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ORGANIZER
}

enum EventStatus {
  DRAFT
  PUBLISHED
  INSCRIPTIONS_OPEN
  ONGOING
  FINISHED
  CANCELED
}

enum EventType {
  FREE
  PAID
}

enum RegistrationStatus {
  PENDING
  WAITING_PAYMENT
  APPROVED
  REJECTED
  CANCELED
  CONFIRMED
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model User {
  id                    String   @id @default(uuid())
  name                  String
  email                 String   @unique
  password_hash         String
  city                  String?
  photo_url             String?
  role                  Role     @default(USER)
  rating_organizer      Float    @default(0.0)
  visibility_participation Boolean @default(true)
  created_at            DateTime @default(now())

  events                Event[]  @relation("OrganizerEvents")
  registrations         Registration[]
  reviews               Review[]
  certificates          Certificate[]
  
  sent_friendships      Friendship[] @relation("SentFriendships")
  received_friendships  Friendship[] @relation("ReceivedFriendships")
  
  sent_messages         Message[] @relation("SentMessages")
  received_messages     Message[] @relation("ReceivedMessages")
  
  notifications         Notification[]
}

model Event {
  id                    String      @id @default(uuid())
  organizer_id          String
  organizer             User        @relation("OrganizerEvents", fields: [organizer_id], references: [id])
  title                 String
  description           String      @db.Text
  location_address      String?
  location_url          String?
  start_date            DateTime
  end_date              DateTime
  price                 Float       @default(0.0)
  type                  EventType   @default(FREE)
  requires_approval     Boolean     @default(false)
  max_inscriptions      Int?
  inscriptions_open_at  DateTime?
  inscriptions_close_at DateTime?
  n_checkins_allowed    Int         @default(1)
  status                EventStatus @default(DRAFT)
  banner_url            String?
  workload_hours        Int?
  payment_info          String?     // Chave PIX ou instruções
  created_at            DateTime    @default(now())

  registrations         Registration[]
  reviews               Review[]
  certificates          Certificate[]
}

model Registration {
  id                    String             @id @default(uuid())
  event_id              String
  event                 Event              @relation(fields: [event_id], references: [id])
  user_id               String
  user                  User               @relation(fields: [user_id], references: [id])
  status                RegistrationStatus @default(PENDING)
  payment_timestamp     DateTime?
  created_at            DateTime           @default(now())
  
  checkins              Checkin[]

  @@unique([event_id, user_id])
}

model Checkin {
  id              String       @id @default(uuid())
  registration_id String
  registration    Registration @relation(fields: [registration_id], references: [id])
  timestamp       DateTime     @default(now())
  method          String       @default("MANUAL") // MANUAL, QR
}

model Friendship {
  id              String           @id @default(uuid())
  requester_id    String
  requester       User             @relation("SentFriendships", fields: [requester_id], references: [id])
  addressee_id    String
  addressee       User             @relation("ReceivedFriendships", fields: [addressee_id], references: [id])
  status          FriendshipStatus @default(PENDING)
  created_at      DateTime         @default(now())

  @@unique([requester_id, addressee_id])
}

model Message {
  id              String   @id @default(uuid())
  sender_id       String
  sender          User     @relation("SentMessages", fields: [sender_id], references: [id])
  receiver_id     String
  receiver        User     @relation("ReceivedMessages", fields: [receiver_id], references: [id])
  content         String
  attachment_url  String?
  created_at      DateTime @default(now())
}

model Review {
  id          String   @id @default(uuid())
  event_id    String
  event       Event    @relation(fields: [event_id], references: [id])
  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  rating      Int      // 1-5
  comment     String?
  created_at  DateTime @default(now())

  @@unique([event_id, user_id])
}

model Certificate {
  id              String   @id @default(uuid())
  event_id        String
  event           Event    @relation(fields: [event_id], references: [id])
  user_id         String
  user            User     @relation(fields: [user_id], references: [id])
  pdf_url         String
  validation_code String   @unique // Hash
  issued_at       DateTime @default(now())

  @@unique([event_id, user_id])
}

model Notification {
  id          String   @id @default(uuid())
  user_id     String
  user        User     @relation(fields: [user_id], references: [id])
  title       String
  content     String
  read        Boolean  @default(false)
  created_at  DateTime @default(now())
}
